import re
import pymongo
from difflib import SequenceMatcher
import operator
import os
import pandas as pd
from enum import Enum


ops = {
    '<' : operator.lt,
    '<=' : operator.le,
    '>' : operator.gt,
    '>=' : operator.ge,  # use operator.div for Python 2
    '=' : operator.eq,
    '==' : operator.eq,
}

class ItemType(Enum):
    OPERATOR = 'operator'
    VERSION = 'version'
    ALL = 'all'

def analyzeManifest(versionModule, cveManifest):
    if type(cveManifest) == list:
        cveManifest = ' '.join(cveManifest)
    versionModule = versionModule.lower()
    cveManifest  = cveManifest.lower()
    cveManifest = cveManifest.split()
    cveManifest, manifestType = identifyElements(cveManifest)
    vulnerable = checkVulnerability(cveManifest, manifestType, versionModule)
    return vulnerable
    
def compareVersions(cveManifest, versionModule, directCompare=True):
    vulnerable = False
    if not directCompare:
        vulnerable = compareCompleteManifest(cveManifest, versionModule)
    else:
        vulnerable = compareEqVersions(cveManifest, versionModule)
    return vulnerable

def compare(operator, cveVersion, moduleVersion):
    # print("Operator ",operator)
    # print("cveVersion ",cveVersion)
    # print("moduleVersion ",moduleVersion)
    # print("Operator identified ", ops[operator])
    return ops[operator](moduleVersion, cveVersion)

def compareEqVersions(cveManifest, versionModule):
    vulnerable = False
    for item in cveManifest:
        if item["tag"] == ItemType.VERSION.value:
            currentVersion = item["item"].replace(" ", "")
            vulnerable = vulnerable or operator.eq(currentVersion, versionModule.replace(" ", ""))
    return vulnerable

def compareCompleteManifest(cveManifest, versionModule):
    operatorReady = None
    vulnerable = False
    firstTime = True
    evaluations = 0
    for idx, item in enumerate(cveManifest):
        if item["tag"] == ItemType.OPERATOR.value:
            operatorReady = item["item"]
        elif item["tag"] == ItemType.VERSION.value and operatorReady:
            if firstTime:
                vulnerable = True
                firstTime = False
            currentVersion = item["item"].replace(" ", "")
            vulnerable = vulnerable and compare(operatorReady.replace(" ", ""), currentVersion, versionModule.replace(" ", ""))
            operatorReady = None
        elif item["tag"] == ItemType.ALL.value and operatorReady:
            vulnerable = True
    return vulnerable
            
            

def checkVulnerability(cveManifest, manifestType, versionModule):
    vulnerable = False
    if manifestType == ItemType.ALL:
        # print("All Versions")
        vulnerable = True
    elif manifestType == ItemType.VERSION:
        # print("Versions equal")
        vulnerable = compareVersions(cveManifest, versionModule)
    elif manifestType == ItemType.OPERATOR:
        # print("Versions operator")
        vulnerable = compareVersions(cveManifest, versionModule, directCompare=False)
    return vulnerable

def identifyElements(cveManifest):
    cveManifestTag = []
    manifestType = ItemType.ALL
    for item in cveManifest:
        if re.match("[<><=>=]", item):
            cveManifestTag.append({"item": item, "tag": ItemType.OPERATOR.value})
            manifestType = ItemType.OPERATOR
        elif re.match(".*[0-9].*", item):
            cveManifestTag.append({"item": item, "tag": ItemType.VERSION.value})
            if manifestType != ItemType.OPERATOR:
                manifestType = ItemType.VERSION
        else:
            cveManifestTag.append({"item": item, "tag": ItemType.ALL.value})
    return cveManifestTag, manifestType
        
    
def getCvesMatchModule(module, databaseName):
    myclient = pymongo.MongoClient("mongodb+srv://afelipevargasr:9TC5hlN9CdC3czP6@cluster0.lrohl7y.mongodb.net/?retryWrites=true&w=majority")
    mydb = myclient["cve_simplifications"]
    mycol = mydb[databaseName]
    myquery = { "vulnerable_versions.module": { "$regex": "(?i)" + module } }
    cves = mycol.find()
    return cves

def analyzeEachModule(cve, module, version, tolerationRate):
    vulnerable = False
    for item in cve["vulnerable_versions"]:
        matchRatio = SequenceMatcher(None,module,item["module"].lower()).ratio()
        if matchRatio >= tolerationRate:
        # if re.match("(?i)" + module, item["module"]):
            # print(cve["CVE_ID"])
            # print(item["module"])
            # print(matchRatio)
            vulnerable = vulnerable or analyzeManifest(version, item["versions"])
            # print(vulnerable)
            # print(item["module"]," ", vulnerable)
    return vulnerable

def analyzeVulnerabilities(module, version, databaseName, tolerationRate):
    module = module.lower()
    version = version.lower()
    cves = getCvesMatchModule(module, databaseName)
    cvesVulnerable = []
    for cve in cves:
        # print(cve["CVE_ID"])
        vulnerable = analyzeEachModule(cve, module, version, tolerationRate)
        if vulnerable:
            cvesVulnerable.append(cve["CVE_ID"])
    # print(len(cvesVulnerable), " ", " CVEs detected")
    return cvesVulnerable

def checkModule(module, version, realVulnerabilities, database):
    db = database["db"]
    tolerance = database["tolerance"]
    vulnerabilities = analyzeVulnerabilities(module, version, db, tolerance)
    passComparison = (realVulnerabilities == len(vulnerabilities))
    similarity = 0
    if passComparison:
        similarity = 100
    elif not passComparison and realVulnerabilities == 0:
        similarity = 0  
    elif realVulnerabilities != 0:
        similarity = len(vulnerabilities)*100/realVulnerabilities
        if realVulnerabilities < len(vulnerabilities):
            similarity = similarity * -1
            
    
    res = { 
            "db": database,
            "tolerance": tolerance,
            "module": module, 
            "version": version, 
            "realVulnerabilities": realVulnerabilities,
            "dbVulnerabilitiesLen": len(vulnerabilities),
            "dbVulnerabilities": vulnerabilities,
            "passComparison": passComparison,
            "similarity": similarity
    }
    return res
    

def runBulkModuleExperiment(modules, database):
    comparisonResults = pd.DataFrame(columns=['db',
                                              'module',
                                              'tolerance',
                                              'version',
                                              'realVulnerabilities',
                                              'dbVulnerabilitiesLen',
                                              'dbVulnerabilities',
                                              'passComparison',
                                              'similarity'])
    for index, module in modules.iterrows():
        moduleRes = checkModule(module["module"], module["version"], module["vulnerableCVES"], database)
        comparisonResults.loc[len(comparisonResults)] = moduleRes
    return comparisonResults

def resultsAnalyzis(databaseExperiment):
    totalModules = len(databaseExperiment)
    passModules = len(databaseExperiment[databaseExperiment["passComparison"]==True])
    failModules = len(databaseExperiment[databaseExperiment["passComparison"]==False])
    passRate = passModules/totalModules
    failRate = failModules/totalModules
    similarityMean = databaseExperiment[["similarity"]].mean()
    print("passRate: ", passRate)
    print("failRate: ", failRate)
    print("similarityMean: ", similarityMean)

def readExperimentConfiguration(outdir,configFile, experiment):
    modules = pd.read_csv(configFile)
    databases = [
        {"db": "database-human-1", "tolerance": 0.96 },
        {"db": "database-openai-2", "tolerance": 0.96 },
        {"db": "database-heuristic-4", "tolerance": 0.62 }
    ]
    for database in databases:
        tempDir = outdir + '/' + database["db"]
        print("Analyzing ", database["db"]," with tolerance: ",database["tolerance"])
        result = runBulkModuleExperiment(modules, database)
        if not os.path.exists(tempDir):
            os.mkdir(tempDir)
        fullname = os.path.join(tempDir, experiment + '.csv')    
        result.to_csv(fullname)
        resultsAnalyzis(result)
        
 
 
readExperimentConfiguration('results/comparison', "experiment_modules.csv","experiment-test-1")
 
 
    
# print(analyzeVulnerabilities("APOGEE MBC (PPC) (P2 Ethernet)", "V3.2", "database-human-1"))
# print(analyzeVulnerabilities("APOGEE MBC (PPC) (P2 Ethernet)", "V3.2", "database-openai-2"))
#print(analyzeVulnerabilities("APOGEE MBC (PPC) (P2 Ethernet)", "V3.2", "database-heuristic-4"))

# print(analyzeManifest("MS_2.6.9900","MS_2.6.9900"))
# print(analyzeManifest("0.9.1","0.9.1 and 0.8.5"))
# print(analyzeManifest("V3.5.4","All versions < V3.5.5"))
# print(operator.ge("V2.3","V2.3"))